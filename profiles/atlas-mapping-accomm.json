{
  "source": {
    "type": "MONGO",
    "connection": {
      "server": "localhost",
      "port": 27017,
      "database": "ATAPProd"
    },
    "query": {
      "collection": "_data_import",
      "aggregate": [
        {
          "$match": {
            "status": "ACTIVE",
            "update_ts": {
              "$gte": "_$i:update_ts"
            },
            "productCategoryId": "_$category"
          }
        },
        {
          "$project": {
            "_id": false,
            "id": "$productId",
            "rooms": {
              "$map": {
                "input": "$services",
                "in": {
                  "id": "$$this.serviceId",
                  "name": "$$this.serviceName",
                  "description": "$$this.serviceDescription",
                  "code": "$$this.productNumber",
                  "hero_image": {
                    "$arrayElemAt": [
                      {
                        "$map": {
                          "input": {
                            "$filter": {
                              "input": "$$this.multimedia",
                              "as": "mm",
                              "cond": {
                                "$eq": [
                                  "$$mm.attributeIdMultimediaContent",
                                  "IMAGE"
                                ]
                              }
                            }
                          },
                          "as": "hero",
                          "in": {
                            "id": "$$hero.id",
                            "path": "$$hero.serverPath",
                            "dimension": "$$hero.attributeIdSizeOrientation",
                            "orientation": {
                              "$switch": {
                                "branches": [
                                  {
                                    "case": {
                                      "$in": [
                                        "$$hero.attributeIdSizeOrientation",
                                        [
                                          "4X3",
                                          "16X9"
                                        ]
                                      ]
                                    },
                                    "then": "LANDSCAPE"
                                  }
                                ],
                                "default": ""
                              }
                            },
                            "width": "$$hero.width",
                            "height": "$$hero.height",
                            "alt": "$$hero.altText",
                            "caption": "$$hero.caption",
                            "author": "$$hero.photographer",
                            "copyright": "$$hero.copyright",
                            "atdw_sq_number": "$$hero.sequenceNumber",
                            "sizes": {
                              "thumb": {
                                "path": {
                                  "$concat": [
                                    "$$hero.serverPath",
                                    "?w=100"
                                  ]
                                },
                                "width": 100
                              },
                              "small": {
                                "path": {
                                  "$concat": [
                                    "$$hero.serverPath",
                                    "?w=640"
                                  ]
                                },
                                "width": 640
                              },
                              "medium": {
                                "path": {
                                  "$concat": [
                                    "$$hero.serverPath",
                                    "?w=960"
                                  ]
                                },
                                "width": 960
                              },
                              "large": {
                                "path": {
                                  "$concat": [
                                    "$$hero.serverPath",
                                    "?w=1024"
                                  ]
                                },
                                "width": 1024
                              }
                            }
                          }
                        }
                      },
                      0
                    ]
                  },
                  "images": {
                    "$map": {
                      "input": {
                        "$filter": {
                          "input": "$$this.multimedia",
                          "as": "svcmm",
                          "cond": {
                            "$eq": [
                              "$$svcmm.attributeIdMultimediaContent",
                              "IMAGE"
                            ]
                          }
                        }
                      },
                      "as": "hero",
                      "in": {
                        "id": "$$hero.id",
                        "path": "$$hero.serverPath",
                        "dimension": "$$hero.attributeIdSizeOrientation",
                        "orientation": {
                          "$switch": {
                            "branches": [
                              {
                                "case": {
                                  "$in": [
                                    "$$hero.attributeIdSizeOrientation",
                                    [
                                      "4X3",
                                      "16X9"
                                    ]
                                  ]
                                },
                                "then": "LANDSCAPE"
                              }
                            ],
                            "default": ""
                          }
                        },
                        "width": "$$hero.width",
                        "height": "$$hero.height",
                        "alt": "$$hero.altText",
                        "caption": "$$hero.caption",
                        "author": "$$hero.photographer",
                        "copyright": "$$hero.copyright",
                        "atdw_sq_number": "$$hero.sequenceNumber",
                        "sizes": {
                          "thumb": {
                            "path": {
                              "$concat": [
                                "$$hero.serverPath",
                                "?w=100"
                              ]
                            },
                            "width": 100
                          },
                          "small": {
                            "path": {
                              "$concat": [
                                "$$hero.serverPath",
                                "?w=640"
                              ]
                            },
                            "width": 640
                          },
                          "medium": {
                            "path": {
                              "$concat": [
                                "$$hero.serverPath",
                                "?w=960"
                              ]
                            },
                            "width": 960
                          },
                          "large": {
                            "path": {
                              "$concat": [
                                "$$hero.serverPath",
                                "?w=1024"
                              ]
                            },
                            "width": 1024
                          }
                        }
                      }
                    }
                  },
                  "subtypes": {
                    "$map": {
                      "input": "$$this.verticalClassifications",
                      "as": "subtype",
                      "in": {
                        "type": "$$subtype.productTypeId",
                        "description": "$$subtype.productTypeDescription"
                      }
                    }
                  },
                  "attributes": {
                    "$map": {
                      "input": "$$this.attributes",
                      "as": "attribute",
                      "in": {
                        "type_id": "$$attribute.attributeTypeId",
                        "type": "$$attribute.attributeTypeDescription",
                        "id": "$$attribute.attributeId",
                        "description": "$$attribute.attributeIdDescription"
                      }
                    }
                  },
                  "facilities": {
                    "$map": {
                      "input": {
                        "$filter": {
                          "input": "$$this.attributes",
                          "as": "att",
                          "cond": {
                            "$eq": [
                              "$$att.attributeTypeId",
                              "SVC FAC"
                            ]
                          }
                        }
                      },
                      "as": "svcfac",
                      "in": {
                        "id": "$$svcfac.attributeId",
                        "description": "$$svcfac.attributeIdDescription",
                        "type": "$$svcfac.attributeTypeIdDescription",
                        "type_id": "$$svcfac.attributeTypeId"
                      }
                    }
                  },
                  "configurations": {
                    "$map": {
                      "input": "$$this.configuration",
                      "as": "rconfig",
                      "in": {
                        "id": "$$rconfig.attributeIdServiceConfiguration",
                        "description": "$$rconfig.attributeIdServiceConfigurationDescription",
                        "capacities": {
                          "min": {
                            "$convert": {
                              "input": "$$rconfig.minimumCapacity",
                              "to": "int",
                              "onError": 0,
                              "onNull": 0
                            }
                          },
                          "max": {
                            "$convert": {
                              "input": "$$rconfig.maximumCapacity",
                              "to": "int",
                              "onError": 0,
                              "onNull": 0
                            }
                          }
                        }
                      }
                    }
                  },
                  "rates": {
                    "$map": {
                      "input": "$$this.serviceIndicativePrices",
                      "as": "rate",
                      "in": {
                        "from": {
                          "$convert": {
                            "input": "$$rate.range1FromRate",
                            "to": "double",
                            "onError": 0,
                            "onNull": 0
                          }
                        },
                        "to": {
                          "$convert": {
                            "input": "$$rate.range1ToRate",
                            "to": "double",
                            "onError": 0,
                            "onNull": 0
                          }
                        },
                        "comment": "$$rate.range1CommentText"
                      }
                    }
                  }
                }
              }
            },
            "rate": {
              "from": {
                "$convert": {
                  "input": "$rateFrom",
                  "to": "double",
                  "onError": 0,
                  "onNull": 0
                }
              },
              "to": {
                "$convert": {
                  "input": "$rateTo",
                  "to": "double",
                  "onError": 0,
                  "onNull": 0
                }
              }
            },
            "info": {
              "rates": {
                "$map": {
                  "input": "$rates",
                  "in": {
                    "from": {
                      "$convert": {
                        "input": "$$this.priceFrom",
                        "to": "double",
                        "onError": 0,
                        "onNull": 0
                      }
                    },
                    "to": {
                      "$convert": {
                        "input": "$$this.priceTo",
                        "to": "double",
                        "onError": 0,
                        "onNull": 0
                      }
                    },
                    "free": "$$this.free",
                    "comment": "$$this.rateComment",
                    "rate_type": "$$this.ratesType"
                  }
                }
              }
            }
          }
        }
      ]
    }
  },
  "dest": {
    "type": "MONGO",
    "connection": {
      "server": "localhost",
      "port": 27017,
      "database": "ATAPProd"
    },
    "query": {
      "collection": "estates",
      "find": {
        "id": "{id}",
        "contributor": "ATDW"
      },
      "update": {
        "$set": {
          "rooms": "_$rooms",
          "rate": "_$rate",
          "info": "_$info"
        },
        "$currentDate": {
          "update_date": true
        }
      }
    }
  },
  "logs": {
    "process": {
      "path": "/var/log/ATICProd/dataBridge/atdw-mapping",
      "db_log": {
        "server": "localhost",
        "port": 27017,
        "database": "ATAPProd",
        "collection": "_data_import"
      }
    },
    "error": {
      "path": "/var/log/ATICProd/dataBridge/atdw-mapping-error",
      "db_log": {
        "server": "localhost",
        "port": 27017,
        "database": "ATAPProd",
        "collection": "_data_import"
      }
    }
  }
}
